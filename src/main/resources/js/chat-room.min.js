var el,ctx,isDrawing=!1,x=0,y=0,isClick=!0,ChatRoom={init:function(){if(0===$("#chatContent").length)return!1;ChatRoom.editor=Util.newVditor({id:"chatContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},toolbar:["emoji","headings","bold","italic","|","link","upload","|","undo","redo","|","edit-mode","fullscreen",{name:"more",toolbar:["table","list","ordered-list","check","outdent","indent","quote","code","insert-before","insert-after","info","help"]}],height:150,placeholder:"说点什么吧！",ctrlEnter:function(){ChatRoom.send()}}),ChatRoom.listenUploadEmojis(),ChatRoom.loadEmojis(),(()=>{let e=(new Date).getTime(),t=0;function a(){0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime(),t=setTimeout(()=>{(new Date).getTime()-e<=700&&$("#emojiList").removeClass("showList")},null!==navigator.userAgent.match(/(phone|pad|pod|ios|Android|Mobile|BlackBerry|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian)/i)?0:600)}$("#emojiBtn").hover(function(){0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime(),setTimeout(()=>0!==$("#emojiBtn:hover").length&&$("#emojiList").addClass("showList"),300)},a),$("#emojiList").hover(function(){0!==t&&(clearTimeout(t),t=0),e=(new Date).getTime()},a)})(),$("#redPacketBtn").on("click",function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">红包类型</div>\n  <div class="fn-hr5 fn__5"></div>\n  <select id="redPacketType">\n  <option value="random" selected>拼手气红包</option>  <option value="average">普通红包</option>  <option value="specify">专属红包</option>  <option value="heartbeat">心跳红包</option>  <option value="rockPaperScissors">猜拳红包</option>  </select>\n</label>\n<label id="gesture" style="display:none;">\n  <div class="ft__smaller ft__fade" style="float: left">出拳</div>\n  <div class="fn-hr5 fn__5"></div>\n  <select id="gestureType">\n  <option value="0" selected>石头</option>  <option value="1">剪刀</option>  <option value="2">布</option>  </select>\n</label>\n<label id = "who" style="display:none;">\n  <div class="ft__smaller ft__fade" style="float: left">发给谁</div>\n  <div class="fn-hr5 fn__5"></div>\n  <div id="recivers" class="chats__users">\n                            </div> \n  <select id="userOption" multiple="multiple" style=\'height: 150px; left: 50px\'>\n  </select>\n  <div id="chatUsernameSelectedPanel" class="completed-panel"\n                             style="height:170px;display:none;left:auto;top:auto;cursor:pointer;"></div> \n</label>\n<label id=\'redPacketMoneyLabel\'>\n  <div class="ft__smaller ft__fade" style="float: left">积分</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="20000" required="" value="32" id="redPacketMoney" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label id=\'redPacketCountLabel\'>\n  <div class="ft__smaller ft__fade" style="float: left" id="countx">个数</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="1" max="1000" required="" value="2" id="redPacketCount" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">留言</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="redPacketMsg" placeholder="摸鱼者，事竟成！" maxlength="20">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px">\n  <div id=\'totalAmount\' class="fn__flex-1 fn__flex-center" style="text-align: left;">总计：<span id="redPacketAmount">32</span> 积分</div>\n  <button class="btn btn--confirm" id="redPacketConfirm">发送</button>\n</div>\n</div>',"发红包"),$("#userOption").on("change",function(){var e,t=$("#userOption").val(),a=[];for(index in t)a.push(n.get(t[index]));for(e in $("#recivers").html(""),$("#redPacketCount").val(a.length),a)$("#recivers").append('<a target="_blank" data-name="'+a[e].userName+'"\nhref="'+a[e].homePage+'">\n<img style=\'margin-bottom: 10px\' class="avatar avatar-small" aria-label="'+a[e].userName+'"\nsrc="'+a[e].userAvatarURL+'">\n</a>')});var n=new Map;$("#redPacketType").on("change",function(){var e=$("#redPacketType").val();"specify"===e?($("#who").removeAttr("style"),$("#redPacketCount").val("1"),$("#redPacketCount").attr("readOnly","true"),$.ajax({url:Label.servePath+"/chat-room/online-users",type:"GET",cache:!1,success:function(e){if(0==e.code)for(var t in $("#userOption").html(""),e.data.users){t=e.data.users[t];n.set(t.userName,t),$("#userOption").append('<option value="'+t.userName+'">'+t.userName+"</option>\n")}},error:function(e){}})):($("#who").css("display","none"),$("#gesture").css("display","none"),$("#redPacketCount").removeAttr("readOnly"),$("#redPacketMoneyLabel").removeAttr("style"),$("#totalAmount").css("display","inline"),$("#countx").text("个数"),$("#redPacketCount").val("1")),"heartbeat"===e&&($("#countx").text("个数（最少5个）"),$("#redPacketCount").val("5")),"rockPaperScissors"===e&&($("#gesture").removeAttr("style"),$("#redPacketCount").val("1"),$("#redPacketCount").attr("readOnly","true")),"dice"===e&&($("#redPacketMoneyLabel").css("display","none"),$("#totalAmount").css("display","none"),$("#countx").text("开盘人数"),$("#redPacketCount").val("3"))}),$("#redPacketMoney").unbind(),$("#redPacketCount").unbind(),$("#redPacketMoney").on("change",function(){""===$("#redPacketMoney").val()&&$("#redPacketMoney").val("32"),$("#redPacketMoney").val()<32&&$("#redPacketMoney").val("32"),$("#redPacketAmount").text($("#redPacketMoney").val())}),$("#redPacketMoney,#redPacketCount").bind("input propertychange",function(){var e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！")):"rockPaperScissors"===e&&$("#redPacketAmount").text($("#redPacketMoney").val())}),$("#redPacketType").on("change",function(){var e=$("#redPacketType").val();"average"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("平分红包，人人有份！")):"random"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("摸鱼者，事竟成！")):"specify"===e?($("#redPacketAmount").text($("#redPacketMoney").val()*$("#redPacketCount").val()),$("#redPacketMsg").val("试试看，这是给你的红包吗？")):"heartbeat"===e?($("#redPacketAmount").text($("#redPacketMoney").val()),$("#redPacketMsg").val("玩的就是心跳！")):"rockPaperScissors"===e?$("#redPacketMsg").val("石头剪刀布！"):"dice"===e&&$("#redPacketMsg").val("买定离手！")}),$("#redPacketCount").on("change",function(){var e=$("#redPacketType").val();"dice"===e&&(15<$("#redPacketCount").val()&&$("#redPacketCount").val("15"),$("#redPacketCount").val()<3&&$("#redPacketCount").val("3")),"heartbeat"===e&&$("#redPacketCount").val()<5&&$("#redPacketCount").val("5"),Number($("#redPacketCount").val())>Number($("#redPacketMoney").val())?$("#redPacketCount").val($("#redPacketMoney").val()):(100<$("#redPacketCount").val()&&$("#redPacketCount").val("100"),$("#redPacketCount").val()<=0&&$("#redPacketCount").val("1"))}),$("#redPacketConfirm").on("click",function(){let e=$("#redPacketType").val();var t=$("#redPacketMoney").val(),a=$("#redPacketCount").val();let n=$("#redPacketMsg").val(),o=$("#userOption").val();var s=$("#gestureType").val();""!==e&&null!==e&&void 0!==e||(e="random"),void 0===o&&(o=[]),0==o.length&&"specify"===e&&$("#chatContentTip").addClass("error").html("<ul><li>请选择红包发送对象</li></ul>"),""===n&&(n="摸鱼者，事竟成！");let i;i="rockPaperScissors"!==e?{type:e,money:t,count:a,msg:n,recivers:o}:{type:e,money:t,count:a,msg:n,recivers:o,gesture:s};s={content:"[redpacket]"+JSON.stringify(i)+"[/redpacket]"};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(s),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}}),Util.closeAlert()})}),ChatRoom.loadAvatarPendant(),ChatRoom.loadXiaoIceGame(),ChatRoom.charInit("paintCanvas"),$("#paintBtn").on("click",function(){"none"===$("#paintContent").css("display")?$("#paintContent").slideDown(1e3):$("#paintContent").slideUp(1e3)}),$("#selectColor").cxColor(),$("#selectColor").bind("change",function(){ChatRoom.changeColor(this.value)}),$("#selectWidth").bind("change",function(){var e=$("#selectWidth").val();ChatRoom.changeWidth(e)})},submitCharacter:function(e){var t;0!==linesArray.length?(t=function(e){var t=e.split(","),e=t[0].match(/:(.*?);/)[1],a=atob(t[1]),n=a.length,o=new Uint8Array(n);for(;n--;)o[n]=a.charCodeAt(n);return new Blob([o],{type:e})}(document.getElementById(e).toDataURL()),(e=new FormData).append("file[]",t),$.ajax({url:Label.servePath+"/upload",type:"POST",cache:!1,data:e,processData:!1,contentType:!1,success:function(e){e=e.data.succMap.blob;ChatRoom.editor.setValue(ChatRoom.editor.getValue()+"![涂鸦]("+e+")"),ChatRoom.editor.focus(),ChatRoom.clearCharacter("paintCanvas"),$("#paintContent").slideUp(500)},error:function(e){}}),linesArray=[],$(window).scrollTop(0)):alert("画布为空，无法提交！")},clearCharacter:function(e){e=document.getElementById(e).getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),linesArray=[]},revokeChatacter:function(e){0<linesArray.length&&(ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),linesArray.pop(),linesArray.forEach(t=>{ChatRoom.changeColor(t.color),ChatRoom.changeWidth(t.width),ctx.beginPath(),ctx.moveTo(t.point[0].x,t.point[0].y);for(let e=1;e<t.point.length;e++)ctx.lineTo(t.point[e].x,t.point[e].y);ctx.stroke()}))},changeColor:function(e){ctx.fillStyle=ctx.strokeStyle=ctx.shadowColor=e},changeWidth:function(e){ctx.lineWidth=e},charInit:function(e){el=document.getElementById(e),(ctx=el.getContext("2d")).fillStyle=ctx.strokeStyle=ctx.shadowColor="#000",ctx.lineWidth=3,ctx.lineJoin="miter",ctx.lineCap="round",ctx.shadowBlur=2,el.onmousedown=function(e){pointsArray=[],isClick=isDrawing=!0,ctx.beginPath(),x=e.clientX-e.target.offsetLeft+$(window).scrollLeft(),y=e.clientY-e.target.offsetTop+$(window).scrollTop(),pointsArray.push({x:x,y:y}),ctx.moveTo(x,y)},el.onmousemove=function(e){isDrawing&&(isClick=!1,x=e.clientX-e.target.offsetLeft+$(window).scrollLeft(),y=e.clientY-e.target.offsetTop+$(window).scrollTop(),pointsArray.push({x:x,y:y}),ctx.lineTo(x,y),ctx.stroke())},el.onmouseup=function(){linesArray.push({point:pointsArray,color:ctx.fillStyle,width:ctx.lineWidth}),isClick&&(ctx.lineTo(x,y),ctx.stroke()),isDrawing=!1},el.addEventListener("touchstart",function(e){isClick=!0,pointsArray=[],ctx.beginPath(),x=e.changedTouches[0].pageX-e.target.offsetLeft,y=e.changedTouches[0].pageY-e.target.offsetTop,pointsArray.push({x:x,y:y}),ctx.moveTo(x,y)},!1),el.addEventListener("touchmove",function(e){isClick=!1,e.preventDefault(),x=e.changedTouches[0].pageX-e.target.offsetLeft,y=e.changedTouches[0].pageY-e.target.offsetTop,pointsArray.push({x:x,y:y}),ctx.lineTo(x,y),ctx.stroke()},!1),el.addEventListener("touchend",function(e){isClick&&(ctx.lineTo(x,y),ctx.stroke()),linesArray.push({point:pointsArray,color:ctx.fillStyle,width:ctx.lineWidth})},!1)},setDiscuss:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller" style="float: left">修改话题需要16积分，将自动从账户中扣除；<br>最大长度16字符，不合法字符将被自动过滤。</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="discuss-new-title">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.updateDiscussData($("#discuss-new-title").val());Util.closeAlert();\'>设置 <span class=\'count\'><svg style=\'vertical-align: -2px;\'><use xlink:href="#iconPoints"></use></svg> 16</span></button>\n</div>\n</div>',"设置话题")},updateDiscussData:function(e){$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify({content:"[setdiscuss]"+e+"[/setdiscuss]"}),success:function(e){0!==e.code?Util.notice("danger",3e3,e.msg):Util.notice("success",3e3,"话题修改成功，所有人可见。<br>16积分已扣除。")},error:function(e){Util.notice("danger",3e3,e.statusText)}})},useDiscuss:function(){var e=ChatRoom.editor.getValue();ChatRoom.editor.setValue("*`# "+$("#discuss-title").html()+" #`*  "),ChatRoom.editor.insertValue(e,0),ChatRoom.editor.focus()},toggleOnlineAvatar:function(){"none"===$("#chatRoomOnlineCnt").css("display")?($("#chatRoomOnlineCnt").html(Label.onlineAvatarData),setTimeout(function(){$("#toggleAvatarBtn").html('<use xlink:href="#showLess"></use>'),$("#chatRoomOnlineCnt").slideDown(200),setTimeout(function(){Util.listenUserCard()},200)},100)):($("#toggleAvatarBtn").html('<use xlink:href="#showMore"></use>'),$("#chatRoomOnlineCnt").slideUp(200))},confirmed:!1,delEmoji:function(a){if(!0===ChatRoom.confirmed||confirm("确定要删除该表情包吗？")){ChatRoom.confirmed=!0;let t=ChatRoom.getEmojis();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);t.reverse(),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0===e.code?(Util.notice("success",1500,"表情包删除成功。"),ChatRoom.loadEmojis(),setTimeout(function(){$("#emojiBtn").click()},50)):Util.notice("warning",1500,"表情包删除失败："+e.msg)}})}},loadEmojis:function(){let t=ChatRoom.getEmojis(),a="";for(let e=0;e<t.length;e++)a+=`<button onclick="ChatRoom.editor.setValue(ChatRoom.editor.getValue() + '![图片表情](${t[e]})')">
    <div class="divX"><svg onclick='ChatRoom.delEmoji("${t[e]}");event.cancelBubble =true;' style="width: 15px; height: 15px;"><use xlink:href="#delIcon"></use></svg></div>
    <img style='max-height: 50px' class="vditor-emojis__icon" src="${t[e]}">
</button>`;$("#emojis").html(a)},listenUploadEmojis:function(){$("#uploadEmoji").fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5242880,multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,a){var t;ext=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob?((t=new FileReader).readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));isImage(t)?5242880<e.target.result.byteLength?Util.alert("图片过大 (最大限制 5M)"):a.submit():Util.alert("只允许上传图片!")}):a.submit()},formData:function(e){return e.serializeArray()},submit:function(e,t){},done:function(e,t){t={result:{key:t.result.data.succMap[Object.keys(t.result.data.succMap)[0]]}};ChatRoom.addEmoji(t.result.key)},fail:function(e,t){Util.alert("Upload error: "+t.errorThrown)}})},fromURL:function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">请输入图片的URL</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="fromURL">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px; justify-content: flex-end;">\n  <button class="btn btn--confirm" onclick=\'ChatRoom.addEmoji($("#fromURL").val());Util.closeAlert();\'>导入</button>\n</div>\n</div>',"从URL导入表情包"),$("#fromURL").focus(),$("#fromURL").unbind(),$("#fromURL").bind("keypress",function(e){"13"==e.keyCode&&(ChatRoom.addEmoji($("#fromURL").val()),Util.closeAlert())})},addEmoji:function(){for(let e=0;e<arguments.length;e++){var a=arguments[e];let t=ChatRoom.getEmojis();t.reverse();for(let e=0;e<t.length;e++)t[e]===a&&t.splice(e,1);t.push(a),$.ajax({url:Label.servePath+"/api/cloud/sync",method:"POST",data:JSON.stringify({gameId:"emojis",data:t}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){0!==e.code&&Util.notice("warning",1500,"表情包上传失败："+e.msg)}})}Util.notice("success",1500,"表情包上传成功。"),$("details[open]").removeAttr("open"),ChatRoom.loadEmojis()},getEmojis:function(){let t;return $.ajax({url:Label.servePath+"/api/cloud/get",method:"POST",data:JSON.stringify({gameId:"emojis"}),headers:{csrfToken:Label.csrfToken},async:!1,success:function(e){t=0===e.code&&""!==e.data?Util.parseArray(e.data):[]}}),t.reverse(),t},isSend:!1,send:function(){var t,e;ChatRoom.isSend||(ChatRoom.isSend=!0,e={content:t=ChatRoom.editor.getValue()},ChatRoom.editor.setValue(""),$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(e),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(e){0===e.code?$("#chatContentTip").removeClass("error succ").html(""):($("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>"),ChatRoom.editor.setValue(t))},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>"),ChatRoom.editor.setValue(t)},complete:function(e,t){ChatRoom.isSend=!1,$(".form button.red").removeAttr("disabled").css("opacity","1")}}))},more:function(){NProgress.start(),setTimeout(function(){page++;let e;var t;1!==page&&(t=(t=$(".chats__item"))[t.length-1],e=$(t).attr("id").replace("chatroom","")),Label.hasMore&&(1===page?$.ajax({url:Label.servePath+"/chat-room/more?page="+page,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t];0===$("#chatroom"+t.oId).length&&ChatRoom.renderMsg(t,"more"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard(),ChatRoom.imageViewer()}else alert("没有更多聊天消息了！"),Label.hasMore=!1}}):$.ajax({url:Label.servePath+"/chat-room/getMessage?size=25&mode=1&oId="+e,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t];0===$("#chatroom"+t.oId).length&&ChatRoom.renderMsg(t,"more"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard(),ChatRoom.imageViewer()}else alert("没有更多聊天消息了！"),Label.hasMore=!1}})),NProgress.done()},0)},resetMoreBtnListen:function(){$("body").unbind(),$("body").click(function(e){"aPersonListPanel"!==$(e.target).closest("a").attr("id")&&"personListPanel"!==$(e.target).closest(".module").attr("id")&&$("#personListPanel").hide()}),$("body").click(function(){$("details[open]").removeAttr("open")})},groupRevokeProcess:!1,startGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.stopGroupRevoke()"),$("#groupRevoke").html('<svg style="vertical-align: -2px;"><use xlink:href="#administration"></use></svg>\n关闭批量撤回'),Util.notice("warning",6e3,"批量撤回已启动，已在消息中添加便捷撤回按钮。<br>使用完成后请记得关闭此功能。"),ChatRoom.groupRevokeProcess=!0;let e=setInterval(function(){ChatRoom.groupRevokeProcess||($("#chats").empty(),page=0,ChatRoom.more(),clearInterval(e)),$(".chats__item").each(function(){0===$(this).find(".button").length&&($(this).find(".date-bar").css("float","left"),$(this).find(".date-bar").html("<button class='button' onclick='ChatRoom.adminRevoke(\""+$(this).attr("id").replace("chatroom","")+"\")'>撤回</button>"))})},500)},stopGroupRevoke:function(){$("#groupRevoke").attr("onclick","ChatRoom.startGroupRevoke()"),$("#groupRevoke").html('<svg style="vertical-align: -2px;"><use xlink:href="#administration"></use></svg>\n批量撤回'),Util.notice("success",1500,"批量撤回已关闭。"),ChatRoom.groupRevokeProcess=!1},adminRevoke:function(e){$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code||Util.notice("danger",1500,e.msg)}})},revoke:function(e){confirm("确定要撤回吗？")&&$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){0===e.code?Util.notice("success",1500,e.msg):Util.notice("danger",1500,e.msg)}})},repeat:function(e){let t="";$.ajax({url:Label.servePath+"/cr/raw/"+e,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,"")}}),ChatRoom.editor.setValue(t),ChatRoom.send(),$(window).scrollTop(0)},report:function(e){confirm("确定举报吗？")&&$.ajax({url:Label.servePath+"/report",type:"POST",cache:!1,data:JSON.stringify({reportDataId:e,reportDataType:3,reportType:49,reportMemo:""}),complete:function(e){0===e.responseJSON.code?Util.alert("一键举报成功，感谢你的帮助！<br>管理员将进行审核，如情况属实系统会为举报人发放积分奖励，并对违规者进行相应处罚。"):Util.alert(e.responseJSON.msg)}})},at:function(e,a,t){if(ChatRoom.editor.focus(),!0===t)ChatRoom.editor.insertValue("@"+e+"  \n",!1);else{let t="";$.ajax({url:Label.servePath+"/cr/raw/"+a,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,""),t=t.replace(/\n/g,"\n> ")}}),ChatRoom.editor.insertValue("\n##### 引用 @"+e+"  \n> "+t+"\n",!1)}$(window).scrollTop(0)},renderRedPacket:function(i,e,t,a,n,o){let r=!1,l=-1,c,s;if(void 0!==n&&(c=n.winnerResult,s=n.diceParticles),e===t)for(let e=0;e<i.length;e++){var d=i[e];d.userMoney>l&&(l=d.userMoney)}for(let s=0;s<i.length;s++){var u=i[s],m=u.userMoney,f=u.dice,v=u.userName;v===Label.currentUser&&(void 0!==m?0<m?$("#redPacketIGot").text("抢到了 "+m+" 积分"):0==m?$("#redPacketIGot").text("恭喜你，抢了个寂寞"):$("#redPacketIGot").text("什么运气，你竟然被反向抢红包了"):void 0!==f&&$("#redPacketIGot").text("押注 "+f.chips+" 积分"),r=!0);let e="";void 0!==f&&(e=f.bet);let t=v;switch(e){case"big":t=v+" (押大)";break;case"small":t=v+" (押小)";break;case"leopard":t=v+" (豹子)"}var h=u.time;let a="";void 0!==u.avatar&&(a=`<img class="avatar avatar--mid" style="margin-right: 10px; background-image: none; background-color: transparent;" src="${u.avatar}">`);let n=`<li class="fn__flex menu__item">${a}
<div class="fn__flex-1" style="text-align: left !important;">
<h2 class="list__user"><a href="${Label.servePath}/member/${v}">${t}</a>
</h2>`;0<m&&m===l?(l=-1,n+="<span class='green small btn'>来自老王的认可</span><br>\n"):0===m?n+="<span class='red small btn'>0溢事件</span><br>\n":m<0&&(n+="<span class='yellow small btn'>抢红包有风险</span><br>\n"),void 0!==c&&(c===f.bet?n+="<span class='green small btn'>运气好而已</span><br>\n":n+="<span class='red small btn'>别玩了</span><br>\n");let o;o=void 0===m&&void 0!==f?f.chips:m,n+=`<span class="ft__fade ft__smaller">${h}</span>
    </div>
    <div class="fn__flex-center">${o} 积分</div>
</li>
`,$("#redPacketList").append(n)}if(r||$("#redPacketIGot").text(Label.currentUser===o?"金主来了":"你错过了这个红包"),void 0!==a&&0<a.length&&(index=a.indexOf(Label.currentUser),-1===index&&($("#msg").text("这个红包属于 "+a),$("#redPacketIGot").text(Label.currentUser===o?"金主来了":"这个红包不属于你"))),void 0!==c){let e=" ",t=0;for(key in s)t+=s[key];switch(c){case"big":e+=t+"点大";break;case"small":e+=t+"点小";break;case"leopard":e+="豹子通杀"}$("#redPacketIGot").text(s+e)}},bet:function(e){Util.alert('<div class="form fn__flex-column">\n<label id="betRadio">\n  <input type="radio" name="bet" value="big" checked>大\n  <input type="radio" name="bet" value="small">小\n  <input type="radio" name="bet" value="leopard">豹子\n  <div class="ft__smaller ft__fade" style="float: left">筹码</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="32" max="100" required="" value="32" id="chipsLabel" name=\'chips\' onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<div class="fn__flex" style="margin-top: 15px">\n  <button class="btn btn--confirm" onclick="ChatRoom.unpackRedPacket('+e+');Util.clearAlert()">押注</button>\n</div>\n</div>',"买定离手"),$("#chipsLabel").on("change",function(){100<$("#chipsLabel").val()&&$("#chipsLabel").val("100"),$("#chipsLabel").val()<=32&&$("#chipsLabel").val("32")})},selectGesture:function(e){Util.alert(`<div class="form fn__flex-column select-center">
<div>
<label class="gestureRadio">
  <input type="radio" name="gesture" value="0" checked>石头
</label>
<label class="gestureRadio">
  <input type="radio" name="gesture" value="1">剪刀
</label>
<label class="gestureRadio">
  <input type="radio" name="gesture" value="2">布
</label>
</div>
<div class="fn__flex" style="margin-top: 15px">
  <button class="btn btn--confirm" onclick="ChatRoom.unpackRedPacket(${e});Util.clearAlert()">出拳</button>
</div>
</div>`,"出拳")},unpackRedPacket:function(a){$.ajax({url:Label.servePath+"/chat-room/red-packet/open",method:"POST",data:JSON.stringify({oId:a,gesture:$(".gestureRadio>input[name=gesture]:checked").val(),dice:{bet:$("#betRadio>input[name=bet]:checked").val(),chips:$("#betRadio>input[name=chips]").val()}}),success:function(t){if(-1!==t.code){let e="";void 0!==t.info.gesture&&(e=(Label.currentUser===t.info.userName?"你":t.info.userName)+"出拳:  "+["石头","剪刀","布"][t.info.gesture]),Util.alert(`<style>.dialog-header-bg {border-radius: 4px 4px 0 0; background-color: rgb(210, 63, 49); color: rgb(255, 255, 255);}.dialog-main {height: 456px;overflow: auto;}</style><div class="fn-hr5"></div>
<div class="ft__center">
    <div class="fn__flex-inline">
        <img class="avatar avatar--small" src="${t.info.userAvatarURL48}" style="background-image: none; background-color: transparent; width: 20px; height: 20px; margin-right: 0;">
        <div class="fn__space5"></div>
        <a href="${Label.servePath}/member/${t.info.userName}">${t.info.userName}</a>'s 红包
    </div>
    <div class="fn-hr5"></div>
${e?`<div class="ft__smaller ft__fade">${e}</div>`:""}    <div id = "msg" class="ft__smaller ft__fade">
${t.info.msg}
    </div>
    <div class="hongbao__count" id='redPacketIGot'>抢红包人数较多，加载中...</div>
    <div class="ft__smaller ft__fade">总计 ${t.info.got}/${t.info.count}</div>
</div>
<div class="list"><ul id="redPacketList">
</ul></div>`,"红包"),ChatRoom.renderRedPacket(t.who,t.info.count,t.info.got,t.recivers,t.diceRet,t.info.userName),t.info.count===t.info.got&&($("#chatroom"+a).find(".hongbao__item").css("opacity",".36").attr("onclick","ChatRoom.unpackRedPacket("+a+")"),!0===t.dice?$("#chatroom"+a).find(".redPacketDesc").html("已开盘"):$("#chatroom"+a).find(".redPacketDesc").html("已经被抢光啦"))}else Util.alert(t.msg)},error:function(e){Util.alert(e.msg)}})},plusOne:function(){ChatRoom.editor.setValue(Label.latestMessage),ChatRoom.send()},renderMsg:function(s,e){let n=!1;var t=Label.latestMessage===s.md;try{var o=$.parseJSON(s.content.replace("<p>","").replace("</p>",""));if("redPacket"===o.msgType){n=!0;let t="未知类型红包",a="ChatRoom.unpackRedPacket('"+s.oId+"')";switch(o.type){case"random":t="拼手气红包";break;case"average":t="普通红包";break;case"specify":t="专属红包";break;case"heartbeat":t="心跳红包 (慎抢)";break;case"rockPaperScissors":t="石头剪刀布红包",o.senderId!=Label.currentUserId&&(a="ChatRoom.selectGesture('"+s.oId+"')");break;case"dice":if(t="摇骰子",o.senderId!==Label.currentUserId){let e=!1;for(idx in o.who)if(o.who[idx].userId===Label.currentUserId){e=!0;break}e||(a="ChatRoom.bet('"+s.oId+"')")}}if(Number(o.count)===Number(o.got)){let e="已经被抢光啦";"dice"===o.type&&(e="已开盘"),s.content='<div style="opacity: .36;" class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+s.oId+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+o.msg+"<br><b>"+t+'</b></div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n'+e+"\n        </div>\n    </div>\n</div>"}else s.content='<div class="hongbao__item fn__flex-inline" onclick="'+a+'">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+o.msg+"<br><b>"+t+'</b></div>\n        <div class="ft__smaller ft__fade redPacketDesc">\n        </div>\n    </div>\n</div>'}}catch(e){}let a="",i="";void 0!==s.userNickname&&""!==s.userNickname?s.userNickname=s.userNickname+" ("+s.userName+")":s.userNickname=s.userName,Label.currentUser===s.userName&&(a=" chats__item--me",i='<a onclick="ChatRoom.revoke('+s.oId+')" class="item">撤回</a>\n'),Label.level3Permitted&&(i='<a onclick="ChatRoom.revoke('+s.oId+')" class="item"><svg><use xlink:href="#administration"></use></svg> 撤回</a>\n');try{var r=s.content.replace("<p>","").replace("</p>","");let t=Util.parseDom(r),a=!1,n="",o=0;for(let e=0;e<t.length;e++){var l=t.item(e);void 0!==l.src&&(a=!0,0!==o&&(n+=","),n+="'"+l.src+"'",o++)}a&&(i+='<a onclick="ChatRoom.addEmoji('+n+')" class="item">一键收藏表情</a>')}catch(e){}let c='<div class="fn-none">';c+='<div id="chatroom'+s.oId+'" class="fn__flex chats__item'+a+'">\n    <a href="/member/'+s.userName+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+s.userName+'" style="background-image: url(\''+s.userAvatarURL+'\');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n';r=Label.currentUser!==s.userName||t?"":"display: none;";if(c+='<div id="userName" class="ft__fade ft__smaller" style="'+r+'padding-bottom: 3px;border-bottom: 1px solid #eee">\n    <span class="ft-gray">'+s.userNickname+"</span>&nbsp;\n",void 0!==s.sysMetal&&""!==s.sysMetal){var d=JSON.parse(s.sysMetal).list;if(void 0!==d)for(let e=0;e<d.length;e++){var u=d[e];c+="<img title='"+u.name+" - "+u.description+"' src='"+Util.genMiniMetal(u.attr)+"'/>"}}if(c+="</div>",c+='        <div class="vditor-reset ft__smaller '+Label.chatRoomPictureStatus+'">\n            '+s.content+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+s.time+'\n                <span class="fn__space5"></span>\n',n?c+='                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+s.userName+"', '"+s.oId+'\', true)" class="item">@'+s.userName+"</a>\n                        <a onclick=\"ChatRoom.report('"+s.oId+'\')" class="item"><svg><use xlink:href="#icon-report"></use></svg> 一键举报</a>\n                    </details-menu>\n                </details>\n':c+='                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+s.userName+"', '"+s.oId+'\', true)" class="item">@'+s.userName+"</a>\n                        <a onclick=\"ChatRoom.at('"+s.userName+"', '"+s.oId+'\', false)" class="item">引用</a>\n                        <a onclick="ChatRoom.repeat(\''+s.oId+'\')" class="item">复读机</a>\n                        <a onclick="ChatRoom.report(\''+s.oId+'\')" class="item"><svg><use xlink:href="#icon-report"></use></svg> 一键举报</a>\n'+i+"                    </details-menu>\n                </details>\n",c+="        </div>\n    </div>\n</div></div>",e){$("#chats").append(c);let e=$("#chats>div.fn-none");e.show(),e.removeClass("fn-none")}else if(t){let t=++Label.plusN;if(1==t){$("#chats").prepend("<div id='stacked' class='fn__flex' style='position:relative;display:none;'><span id='plusOne' onclick='ChatRoom.plusOne()' style='display:block;margin-left: 20px'><svg style='width: 30px; height: 20px; cursor: pointer;'><use xlink:href='#plusOneIcon'></use></svg></span></div>");let e=$("#chats>div.latest");$("#stacked").prepend(e),e.find("#userName").show(),e.removeClass("latest")}let a=$("#stacked");1!=t&&a.fadeOut(100),setTimeout(function(){a.append(c),a.height(a.height()+27+"px");let e=$("#stacked>div.fn-none");e.show(),e.css("left",9*t+"px"),e.css("top",27*t+"px"),e.css("position","absolute"),e.find(".chats__content").css("background-color",t%2==0?"rgb(240 245 254)":"rgb(245 245 245)"),e.removeClass("fn-none"),a.fadeIn(200)},100)}else{$("#plusOne").remove(),s.md&&(Label.latestMessage=s.md,Label.plusN=0);let e=$("#chats");e.find(".latest").removeClass("latest"),e.prepend(c);let t=$("#chats>div.fn-none");t.slideDown(200),t.addClass("latest"),t.removeClass("fn-none")}},imgViewer:null,imgWaitting:!1,imageViewer:function(){if(!this.imgViewer||$("div.vditor-reset.ft__smaller img:not(.ft__smaller,.emoji,.ext-emoji,*[src*='shield'],*[src*='/gen?'])").length!==this.imgViewer.length){this.imgViewer=this.imgViewer||new Viewer(document.querySelector("#chats"),{inline:!1,className:"PWLimgViwer",filter:e=>!e.parentElement.classList.contains("ft__smaller")&&!e.parentElement.classList.contains("ext-emoji")&&!e.classList.contains("emoji")&&e.src.indexOf("shield")<0&&e.src.indexOf("/gen?")<0,title(){let e=this.images[$(".PWLimgViwer .viewer-active").attr("data-index")];for(;e=e.parentElement,!e.querySelector(".avatar"););return"From @"+e.querySelector(".avatar").getAttribute("aria-label")}});const e=function(){return setTimeout(()=>{ChatRoom.imgViewer.isShown?e():(ChatRoom.imgWaitting=!1,ChatRoom.imgViewer.update())},1e3),!0};this.imgWaitting=this.imgWaitting||e()}},iceWs:"",IceGameCK:localStorage.getItem("IceGameCK")||null,loadXiaoIceGame:function(){iceWs=new WebSocket("wss://game.yuis.cc/wss");let e;iceWs.onopen=function(){iceWs.send(JSON.stringify({type:"setUser",user:Label.currentUser,ck:ChatRoom.IceGameCK,uid:Label.currentUserId})),e=setInterval(()=>{iceWs.send(JSON.stringify({type:"hb"}))},15e3)},iceWs.onclose=function(){$("#iceMsgList").prepend(`<div class="ice-msg-item">
                    <div class="ice-msg-content">小冰网络失去连接</div>
                  </div>`)},iceWs.onerror=function(e){$("#iceMsgList").prepend(`<div class="ice-msg-item">
                    <div class="ice-msg-content">小冰网络维护中...</div>
                  </div>`)},iceWs.onmessage=function(e){var t=JSON.parse(e.data);"all"!==t.user&&t.user!==Label.currentUser||(e=`<div class="ice-msg-item">
                    <div class="ice-msg-content">${t.msg}</div>
                  </div>`,$("#iceMsgList").prepend(e)),"setCK"===t.type&&(ChatRoom.IceGameCK=t.ck,localStorage.setItem("IceGameCK",t.ck))},$("#xiaoIceGameBtn").click(function(){$("#xiaoIceGameBox").show(200),$("#xiaoIceGameBtn").hide(200),setTimeout(()=>{$("#xiaoIceGameBox").addClass("active")},220)}),$("#iceClose").click(function(){const e=$("#xiaoIceGameBox");setTimeout(()=>{$(".ice-chat-input").val(""),$("#xiaoIceGameBox").hide(200),$("#xiaoIceGameBtn").show(200)},e.hasClass("active")?420:1),e.removeClass("active")}),$("#iceMinimize").click(function(){$("#xiaoIceGameBox").toggleClass("active")}),$("#iceSendMsg").click(ChatRoom.sendIceMsg),$(".ice-chat-input").bind("keypress",function(e){13===e.keyCode&&(e.preventDefault(),ChatRoom.sendIceMsg())})},sendIceMsg:function(){var e=$(".ice-chat-input").val();$(".ice-chat-input").val("");var t=`<div class="ice-msg-item me">
                    <div class="ice-msg-content">${e}</div>
                  </div>`;$("#iceMsgList").prepend(t);let a="gameMsg";console.log(/(登录)/.test(e)),/(登录)/.test(e)&&(a="login"),iceWs.send(JSON.stringify({type:a,ck:ChatRoom.IceGameCK,msg:e}))},loadAvatarPendant:function(){var e=(new Date).getFullYear(),t=(new Date).getMonth()+1,a=(new Date).getDate(),n=e+`-${t}-`+a,o={2021:["2021-02-11","2021-02-17"],2022:["2022-01-31","2022-02-06"],2023:["2023-01-21","2023-01-07"],2024:["2024-02-09","2024-02-15"],2025:["2025-01-28","2025-02-03"],2026:["2026-02-16","2026-01-22"]},s={2021:["2021-09-19","2021-09-21"],2022:["2022-09-10","2022-09-12"],2023:["2023-09-29","2023-10-01"],2024:["2024-09-17","2024-09-19"],2025:["2025-10-06","2025-10-09"],2026:["2026-09-25","2026-09-27"]};let i=document.querySelector("body");10===t&&a<=7?i.classList.add("NationalDay"):12===t&&24<=a&&12===t&&a<=25?i.classList.add("Christmas"):new Date(s[e][0])<=new Date(n)&&new Date(s[e][1])>=new Date(n)?i.classList.add("MidAutumnFestival"):new Date(o[e][0])<=new Date(n)&&new Date(o[e][1])>=new Date(n)&&i.classList.add("SpringFestival")}};